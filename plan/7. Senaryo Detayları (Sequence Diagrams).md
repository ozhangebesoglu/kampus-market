[[6. Use Case Diyagramı]]

- - - 


> Bu bölüm, kritik kullanım senaryolarının detaylı akış diyagramlarını ve adım adım etkileşimlerini içerir.

---

## 7.1 Genel Bakış

Sequence diyagramları, aktörler ve sistem bileşenleri arasındaki **zamana bağlı etkileşimleri** görselleştirir. Her senaryo için:
- Katılımcılar (Participants)
- Mesaj akışı (Message Flow)
- Alternatif durumlar (Alt Flows)
- Hata senaryoları (Error Flows)

tanımlanmıştır.

---

## 7.2 Kimlik Doğrulama Senaryoları

### 7.2.1 Kayıt Olma (Sign Up)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           KAYIT OLMA SEQUENCE                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐           │
│  │Misafir │     │  Next.js   │     │  Supabase  │     │   Email    │           │
│  │        │     │  Frontend  │     │   Auth     │     │  Servisi   │           │
│  └───┬────┘     └─────┬──────┘     └─────┬──────┘     └─────┬──────┘           │
│      │                │                  │                  │                   │
│      │ 1. Kayıt formunu aç              │                  │                   │
│      │───────────────►│                  │                  │                   │
│      │                │                  │                  │                   │
│      │ 2. Form renderla                 │                  │                   │
│      │◄───────────────│                  │                  │                   │
│      │                │                  │                  │                   │
│      │ 3. Form doldur (email, şifre, ad)│                  │                   │
│      │───────────────►│                  │                  │                   │
│      │                │                  │                  │                   │
│      │                │ 4. Email format kontrolü            │                   │
│      │                │ (.edu.tr regex)  │                  │                   │
│      │                │─────────┐        │                  │                   │
│      │                │◄────────┘        │                  │                   │
│      │                │                  │                  │                   │
│      │                │ 5. signUp(email, password, metadata)│                   │
│      │                │─────────────────►│                  │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 6. Email unique? │                   │
│      │                │                  │─────────┐        │                   │
│      │                │                  │◄────────┘        │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 7. User oluştur  │                   │
│      │                │                  │─────────┐        │                   │
│      │                │                  │◄────────┘        │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 8. Doğrulama emaili gönder           │
│      │                │                  │─────────────────────────────────────►│
│      │                │                  │                  │                   │
│      │                │                  │                  │ 9. Email gönder   │
│      │                │                  │                  │─────────┐         │
│      │                │                  │                  │◄────────┘         │
│      │                │                  │                  │                   │
│      │                │ 10. Success response               │                   │
│      │                │◄─────────────────│                  │                   │
│      │                │                  │                  │                   │
│      │ 11. "Email'inizi kontrol edin"   │                  │                   │
│      │◄───────────────│                  │                  │                   │
│      │                │                  │                  │                   │
│      │════════════════════════════════════════════════════════════════════════│
│      │                     EMAIL DOĞRULAMA                  │                   │
│      │════════════════════════════════════════════════════════════════════════│
│      │                │                  │                  │                   │
│      │ 12. Email'deki linke tıkla       │                  │                   │
│      │──────────────────────────────────►│                  │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 13. Token doğrula│                   │
│      │                │                  │─────────┐        │                   │
│      │                │                  │◄────────┘        │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 14. is_verified = true              │
│      │                │                  │─────────┐        │                   │
│      │                │                  │◄────────┘        │                   │
│      │                │                  │                  │                   │
│      │ 15. Redirect → Ana sayfa + Session                  │                   │
│      │◄──────────────────────────────────│                  │                   │
│      │                │                  │                  │                   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### Alternatif Akışlar

| ID | Koşul | Adım | Aksiyon |
|:---|:------|:----:|:--------|
| ALT-1 | Email .edu.tr değil | 4 | Hata mesajı göster, form submit engelle |
| ALT-2 | Email zaten kayıtlı | 6 | 409 Conflict, "Bu email zaten kayıtlı" |
| ALT-3 | Şifre zayıf | 4 | Hata mesajı göster, güçlü şifre iste |
| ALT-4 | Email gönderilemedi | 8 | 500 Error, retry mekanizması |
| ALT-5 | Token süresi dolmuş | 13 | "Link süresi dolmuş" + Yeniden gönder |

---

### 7.2.2 Giriş Yapma (Sign In)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           GİRİŞ YAPMA SEQUENCE                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐           │
│  │Misafir │     │  Next.js   │     │  Supabase  │     │  Database  │           │
│  │        │     │  Frontend  │     │   Auth     │     │            │           │
│  └───┬────┘     └─────┬──────┘     └─────┬──────┘     └─────┬──────┘           │
│      │                │                  │                  │                   │
│      │ 1. Giriş formunu aç              │                  │                   │
│      │───────────────►│                  │                  │                   │
│      │                │                  │                  │                   │
│      │ 2. Email + Şifre gir             │                  │                   │
│      │───────────────►│                  │                  │                   │
│      │                │                  │                  │                   │
│      │                │ 3. signInWithPassword(email, password)                 │
│      │                │─────────────────►│                  │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 4. Credentials doğrula              │
│      │                │                  │─────────┐        │                   │
│      │                │                  │◄────────┘        │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 5. User bilgisi getir               │
│      │                │                  │─────────────────►│                   │
│      │                │                  │                  │                   │
│      │                │                  │ 6. User data     │                   │
│      │                │                  │◄─────────────────│                   │
│      │                │                  │                  │                   │
│      │                │                  │ 7. is_banned kontrol                │
│      │                │                  │─────────┐        │                   │
│      │                │                  │◄────────┘        │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 8. JWT token oluştur                │
│      │                │                  │─────────┐        │                   │
│      │                │                  │◄────────┘        │                   │
│      │                │                  │                  │                   │
│      │                │ 9. Session + User data              │                   │
│      │                │◄─────────────────│                  │                   │
│      │                │                  │                  │                   │
│      │                │ 10. Cookie set (httpOnly)           │                   │
│      │                │─────────┐        │                  │                   │
│      │                │◄────────┘        │                  │                   │
│      │                │                  │                  │                   │
│      │ 11. Redirect → Ana sayfa         │                  │                   │
│      │◄───────────────│                  │                  │                   │
│      │                │                  │                  │                   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### Alternatif Akışlar

| ID | Koşul | Adım | Aksiyon |
|:---|:------|:----:|:--------|
| ALT-1 | Yanlış email/şifre | 4 | 401 Unauthorized, "Email veya şifre hatalı" |
| ALT-2 | Email doğrulanmamış | 6 | Uyarı + "Doğrulama emaili gönder" butonu |
| ALT-3 | Kullanıcı banlı | 7 | 403 Forbidden, "Hesabınız askıya alınmış" + sebep |
| ALT-4 | Çok fazla deneme | 4 | 429 Too Many Requests, 15 dk bekleme |

---

### 7.2.3 Şifre Sıfırlama (Password Reset)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         ŞİFRE SIFIRLAMA SEQUENCE                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐           │
│  │Kullanıcı     │  Next.js   │     │  Supabase  │     │   Email    │           │
│  │        │     │  Frontend  │     │   Auth     │     │  Servisi   │           │
│  └───┬────┘     └─────┬──────┘     └─────┬──────┘     └─────┬──────┘           │
│      │                │                  │                  │                   │
│      │ 1. "Şifremi unuttum" tıkla       │                  │                   │
│      │───────────────►│                  │                  │                   │
│      │                │                  │                  │                   │
│      │ 2. Email gir                     │                  │                   │
│      │───────────────►│                  │                  │                   │
│      │                │                  │                  │                   │
│      │                │ 3. resetPasswordForEmail(email)    │                   │
│      │                │─────────────────►│                  │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 4. Email kayıtlı mı?                │
│      │                │                  │─────────┐        │                   │
│      │                │                  │◄────────┘        │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 5. Reset token oluştur              │
│      │                │                  │─────────┐        │                   │
│      │                │                  │◄────────┘        │                   │
│      │                │                  │                  │                   │
│      │                │                  │ 6. Reset email gönder               │
│      │                │                  │─────────────────────────────────────►│
│      │                │                  │                  │                   │
│      │                │ 7. Success       │                  │                   │
│      │                │◄─────────────────│                  │                   │
│      │                │                  │                  │                   │
│      │ 8. "Email gönderildi"            │                  │                   │
│      │◄───────────────│                  │                  │                   │
│      │                │                  │                  │                   │
│      │════════════════════════════════════════════════════════════════════════│
│      │                    YENİ ŞİFRE BELİRLEME              │                   │
│      │════════════════════════════════════════════════════════════════════════│
│      │                │                  │                  │                   │
│      │ 9. Email'deki linke tıkla        │                  │                   │
│      │───────────────►│                  │                  │                   │
│      │                │                  │                  │                   │
│      │ 10. Yeni şifre formunu göster    │                  │                   │
│      │◄───────────────│                  │                  │                   │
│      │                │                  │                  │                   │
│      │ 11. Yeni şifre gir (2 kez)       │                  │                   │
│      │───────────────►│                  │                  │                   │
│      │                │                  │                  │                   │
│      │                │ 12. updateUser({ password })       │                   │
│      │                │─────────────────►│                  │                   │
│      │                │                  │                  │                   │
│      │                │ 13. Success      │                  │                   │
│      │                │◄─────────────────│                  │                   │
│      │                │                  │                  │                   │
│      │ 14. "Şifre güncellendi" → Giriş sayfası             │                   │
│      │◄───────────────│                  │                  │                   │
│      │                │                  │                  │                   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7.3 İlan Yönetimi Senaryoları

### 7.3.1 İlan Oluşturma (Create Listing)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         İLAN OLUŞTURMA SEQUENCE                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐        │
│  │Öğrenci │   │ Next.js  │   │ Supabase │   │ Supabase │   │  Admin   │        │
│  │        │   │ Frontend │   │ Database │   │ Storage  │   │          │        │
│  └───┬────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘        │
│      │             │              │              │              │               │
│      │ 1. "İlan Ver" tıkla        │              │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │             │ 2. Auth kontrolü            │              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 3. is_verified kontrol      │              │               │
│      │             │◄─────────────│              │              │               │
│      │             │              │              │              │               │
│      │ 4. İlan formunu göster     │              │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
│      │ 5. Form doldur             │              │              │               │
│      │   (başlık, açıklama,       │              │              │               │
│      │    fiyat, kategori,        │              │              │               │
│      │    durum)                  │              │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │ 6. Fotoğraf seç (1-5)      │              │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │             │ 7. Fotoğraf validasyonu     │              │               │
│      │             │   (boyut, format)           │              │               │
│      │             │─────────┐    │              │              │               │
│      │             │◄────────┘    │              │              │               │
│      │             │              │              │              │               │
│      │ 8. "Yayınla" tıkla         │              │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │             │ 9. Form validasyonu         │              │               │
│      │             │─────────┐    │              │              │               │
│      │             │◄────────┘    │              │              │               │
│      │             │              │              │              │               │
│      │             │ 10. Fotoğrafları yükle      │              │               │
│      │             │─────────────────────────────►              │               │
│      │             │              │              │              │               │
│      │             │ 11. Fotoğraf URL'leri       │              │               │
│      │             │◄─────────────────────────────              │               │
│      │             │              │              │              │               │
│      │             │ 12. INSERT listing          │              │               │
│      │             │   (status: 'pending')       │              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 13. Listing ID              │              │               │
│      │             │◄─────────────│              │              │               │
│      │             │              │              │              │               │
│      │             │ 14. Admin bildirimi         │              │               │
│      │             │──────────────────────────────────────────►│               │
│      │             │              │              │              │               │
│      │ 15. "İlanınız onay bekliyor"             │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
│      │ 16. İlanlarım sayfasına yönlendir        │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### Form Validasyon Kuralları

| Alan | Kural | Hata Mesajı |
|:-----|:------|:------------|
| Başlık | 5-100 karakter | "Başlık 5-100 karakter olmalı" |
| Açıklama | 20-2000 karakter | "Açıklama 20-2000 karakter olmalı" |
| Fiyat | 0.01 - 100000 TL | "Fiyat 0.01-100.000 TL arasında olmalı" |
| Kategori | Zorunlu | "Kategori seçiniz" |
| Durum | Zorunlu | "Ürün durumu seçiniz" |
| Fotoğraf | Min 1, Max 5 | "En az 1, en fazla 5 fotoğraf yükleyin" |
| Fotoğraf boyutu | Max 5MB | "Fotoğraf boyutu max 5MB olmalı" |
| Fotoğraf formatı | JPG, PNG, WebP | "Sadece JPG, PNG, WebP formatları" |

---

### 7.3.2 İlan Onaylama (Approve Listing)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         İLAN ONAYLAMA SEQUENCE                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐        │
│  │ Admin  │   │ Next.js  │   │ Supabase │   │ Realtime │   │ Öğrenci  │        │
│  │        │   │ Frontend │   │ Database │   │          │   │ (Satıcı) │        │
│  └───┬────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘        │
│      │             │              │              │              │               │
│      │ 1. Admin panel → Bekleyen ilanlar        │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │             │ 2. SELECT * FROM listings   │              │               │
│      │             │    WHERE status = 'pending' │              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 3. Pending listings         │              │               │
│      │             │◄─────────────│              │              │               │
│      │             │              │              │              │               │
│      │ 4. İlan listesini göster   │              │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
│      │ 5. Bir ilan seç            │              │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │ 6. İlan detayını göster    │              │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
│      │ 7. İçeriği incele          │              │              │               │
│      │   (başlık, açıklama,       │              │              │               │
│      │    fotoğraflar)            │              │              │               │
│      │             │              │              │              │               │
│      │ 8. "Onayla" tıkla          │              │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │             │ 9. UPDATE listings          │              │               │
│      │             │    SET status = 'active',   │              │               │
│      │             │    expires_at = NOW() + 30d │              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 10. Success  │              │              │               │
│      │             │◄─────────────│              │              │               │
│      │             │              │              │              │               │
│      │             │ 11. INSERT notification     │              │               │
│      │             │    (type: 'listing_approved')              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 12. Realtime broadcast      │              │               │
│      │             │─────────────────────────────►              │               │
│      │             │              │              │              │               │
│      │             │              │              │ 13. Push notification        │
│      │             │              │              │─────────────►│               │
│      │             │              │              │              │               │
│      │             │ 14. Email gönder            │              │               │
│      │             │   (listing-approved)        │              │               │
│      │             │──────────────────────────────────────────►│               │
│      │             │              │              │              │               │
│      │ 15. "İlan onaylandı" mesajı              │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
│      │ 16. Listeyi güncelle       │              │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 7.3.3 İlan Reddetme (Reject Listing)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         İLAN REDDETME SEQUENCE                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐                       │
│  │ Admin  │   │ Next.js  │   │ Supabase │   │ Öğrenci  │                       │
│  │        │   │ Frontend │   │ Database │   │ (Satıcı) │                       │
│  └───┬────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘                       │
│      │             │              │              │                              │
│      │ 1. İlan detayında "Reddet" tıkla         │                              │
│      │────────────►│              │              │                              │
│      │             │              │              │                              │
│      │ 2. Ret sebebi modalı göster              │                              │
│      │◄────────────│              │              │                              │
│      │             │              │              │                              │
│      │ 3. Ret sebebi seç/yaz      │              │                              │
│      │   ┌─────────────────────────────────┐    │                              │
│      │   │ □ Uygunsuz içerik               │    │                              │
│      │   │ □ Yasak ürün                    │    │                              │
│      │   │ □ Yetersiz açıklama             │    │                              │
│      │   │ □ Düşük kalite fotoğraf         │    │                              │
│      │   │ □ Yanlış kategori               │    │                              │
│      │   │ □ Diğer: [_______________]      │    │                              │
│      │   └─────────────────────────────────┘    │                              │
│      │────────────►│              │              │                              │
│      │             │              │              │                              │
│      │ 4. "Reddet" onayla         │              │                              │
│      │────────────►│              │              │                              │
│      │             │              │              │                              │
│      │             │ 5. UPDATE listings          │                              │
│      │             │    SET status = 'rejected', │                              │
│      │             │    rejection_reason = '...' │                              │
│      │             │─────────────►│              │                              │
│      │             │              │              │                              │
│      │             │ 6. Success   │              │                              │
│      │             │◄─────────────│              │                              │
│      │             │              │              │                              │
│      │             │ 7. Bildirim + Email         │                              │
│      │             │    (sebep dahil)            │                              │
│      │             │──────────────────────────────────────────►│               │
│      │             │              │              │                              │
│      │ 8. "İlan reddedildi" mesajı              │                              │
│      │◄────────────│              │              │                              │
│      │             │              │              │                              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7.4 Mesajlaşma Senaryoları

### 7.4.1 Mesaj Gönderme (Send Message)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         MESAJ GÖNDERME SEQUENCE                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐        │
│  │ Alıcı  │   │ Next.js  │   │ Supabase │   │ Realtime │   │ Satıcı   │        │
│  │(Öğrenci)   │ Frontend │   │ Database │   │          │   │(Öğrenci) │        │
│  └───┬────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘        │
│      │             │              │              │              │               │
│      │ 1. İlan detayında "Mesaj Gönder" tıkla   │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │             │ 2. Kendi ilanı mı kontrol   │              │               │
│      │             │─────────┐    │              │              │               │
│      │             │◄────────┘    │              │              │               │
│      │             │              │              │               │               │
│      │             │ 3. Mevcut konuşma var mı?   │              │               │
│      │             │    SELECT * FROM conversations              │               │
│      │             │    WHERE listing_id = X     │              │               │
│      │             │    AND buyer_id = Y         │              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 4. Konuşma yok              │              │               │
│      │             │◄─────────────│              │              │               │
│      │             │              │              │              │               │
│      │             │ 5. INSERT conversation      │              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 6. Conversation ID          │              │               │
│      │             │◄─────────────│              │              │               │
│      │             │              │              │              │               │
│      │ 7. Mesaj penceresi aç      │              │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
│      │ 8. Mesaj yaz               │              │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │ 9. "Gönder" tıkla / Enter  │              │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │             │ 10. INSERT message          │              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 11. Message ID              │              │               │
│      │             │◄─────────────│              │              │               │
│      │             │              │              │              │               │
│      │             │ 12. UPDATE conversation     │              │               │
│      │             │    (last_message_at)        │              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 13. Realtime broadcast      │              │               │
│      │             │    (channel: conversation_id)              │               │
│      │             │─────────────────────────────►              │               │
│      │             │              │              │              │               │
│      │             │              │              │ 14. Push → Satıcı            │
│      │             │              │              │─────────────►│               │
│      │             │              │              │              │               │
│      │ 15. Mesaj UI'da göster (✓) │              │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
│      │             │              │              │ 16. Mesaj UI'da göster       │
│      │             │              │              │              │◄──────────────│
│      │             │              │              │              │               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 7.4.2 Mesaj Okundu İşaretleme (Mark as Read)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       MESAJ OKUNDU SEQUENCE                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐        │
│  │ Satıcı │   │ Next.js  │   │ Supabase │   │ Realtime │   │  Alıcı   │        │
│  │        │   │ Frontend │   │ Database │   │          │   │          │        │
│  └───┬────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘        │
│      │             │              │              │              │               │
│      │ 1. Konuşmayı aç            │              │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │             │ 2. SELECT messages          │              │               │
│      │             │    WHERE conversation_id = X│              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 3. Messages list            │              │               │
│      │             │◄─────────────│              │              │               │
│      │             │              │              │              │               │
│      │ 4. Mesajları göster        │              │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
│      │             │ 5. UPDATE messages          │              │               │
│      │             │    SET is_read = true,      │              │               │
│      │             │    read_at = NOW()          │              │               │
│      │             │    WHERE sender_id != me    │              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 6. Realtime broadcast       │              │               │
│      │             │    (read_receipt)           │              │               │
│      │             │─────────────────────────────►              │               │
│      │             │              │              │              │               │
│      │             │              │              │ 7. Okundu bilgisi            │
│      │             │              │              │─────────────►│               │
│      │             │              │              │              │               │
│      │             │              │              │              │ 8. ✓ → ✓✓     │
│      │             │              │              │              │◄──────────────│
│      │             │              │              │              │               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7.5 Ödeme Senaryoları

### 7.5.1 Satın Alma (Purchase)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           SATIN ALMA SEQUENCE                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ ┌────────┐│
│  │ Alıcı  │  │ Next.js  │  │ Edge     │  │  Iyzico  │  │  Banka   │ │ Satıcı ││
│  │        │  │ Frontend │  │ Function │  │          │  │          │ │        ││
│  └───┬────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘ └───┬────┘│
│      │            │             │             │             │            │      │
│      │ 1. "Satın Al" tıkla      │             │             │            │      │
│      │───────────►│             │             │             │            │      │
│      │            │             │             │             │            │      │
│      │            │ 2. İlan durumu kontrol     │             │            │      │
│      │            │   (active mi?)             │             │            │      │
│      │            │─────────┐   │             │             │            │      │
│      │            │◄────────┘   │             │             │            │      │
│      │            │             │             │             │            │      │
│      │ 3. Ödeme sayfası göster  │             │             │            │      │
│      │◄───────────│             │             │             │            │      │
│      │            │             │             │             │            │      │
│      │ 4. Kart bilgilerini gir  │             │             │            │      │
│      │   (kart no, son kullanma,│             │             │            │      │
│      │    CVV, ad-soyad)        │             │             │            │      │
│      │───────────►│             │             │             │            │      │
│      │            │             │             │             │            │      │
│      │ 5. "Ödemeyi Tamamla"     │             │             │            │      │
│      │───────────►│             │             │             │            │      │
│      │            │             │             │             │            │      │
│      │            │ 6. initializePayment()    │             │            │      │
│      │            │────────────►│             │             │            │      │
│      │            │             │             │             │            │      │
│      │            │             │ 7. Create 3D Secure Request             │      │
│      │            │             │────────────►│             │            │      │
│      │            │             │             │             │            │      │
│      │            │             │ 8. 3D Secure URL         │            │      │
│      │            │             │◄────────────│             │            │      │
│      │            │             │             │             │            │      │
│      │            │ 9. Redirect URL           │             │            │      │
│      │            │◄────────────│             │             │            │      │
│      │            │             │             │             │            │      │
│      │ 10. 3D Secure sayfasına yönlendir      │             │            │      │
│      │◄───────────│             │             │             │            │      │
│      │            │             │             │             │            │      │
│      │ 11. 3D Secure doğrulama (SMS/Mobil)    │             │            │      │
│      │───────────────────────────────────────────────────────►            │      │
│      │            │             │             │             │            │      │
│      │            │             │             │ 12. Auth    │            │      │
│      │            │             │             │◄────────────│            │      │
│      │            │             │             │             │            │      │
│      │            │             │ 13. Callback (success/fail)            │      │
│      │            │             │◄────────────│             │            │      │
│      │            │             │             │             │            │      │
│      │════════════════════════════════════════════════════════════════════════│
│      │                          BAŞARILI ÖDEME                           │      │
│      │════════════════════════════════════════════════════════════════════════│
│      │            │             │             │             │            │      │
│      │            │             │ 14. INSERT transaction    │            │      │
│      │            │             │    (status: 'completed')  │            │      │
│      │            │             │─────────────►│             │            │      │
│      │            │             │             │             │            │      │
│      │            │             │ 15. UPDATE listing        │            │      │
│      │            │             │    (status: 'sold')       │            │      │
│      │            │             │─────────────►│             │            │      │
│      │            │             │             │             │            │      │
│      │            │             │ 16. Bildirim → Satıcı     │            │      │
│      │            │             │──────────────────────────────────────────────►│
│      │            │             │             │             │            │      │
│      │            │             │ 17. Email → Satıcı        │            │      │
│      │            │             │──────────────────────────────────────────────►│
│      │            │             │             │             │            │      │
│      │            │ 18. Success page          │             │            │      │
│      │            │◄────────────│             │             │            │      │
│      │            │             │             │             │            │      │
│      │ 19. "Satın alma başarılı" 🎉            │             │            │      │
│      │◄───────────│             │             │             │            │      │
│      │            │             │             │             │            │      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### Hata Senaryoları

| Hata | Adım | Aksiyon |
|:-----|:----:|:--------|
| İlan satılmış | 2 | "Bu ilan zaten satılmış" mesajı |
| Kart geçersiz | 7 | "Kart bilgilerini kontrol edin" |
| 3D Secure başarısız | 11 | "Doğrulama başarısız" + tekrar dene |
| Yetersiz bakiye | 12 | "Yetersiz bakiye" mesajı |
| Timeout | 13 | "İşlem zaman aşımına uğradı" |
| Iyzico hatası | 7 | "Ödeme servisi hatası, tekrar deneyin" |

---

## 7.6 Sistem Senaryoları

### 7.6.1 İlan Süresi Kontrolü (Cron Job)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      İLAN SÜRESİ KONTROLÜ SEQUENCE                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐        │
│  │  Cron  │   │  Edge    │   │ Supabase │   │ Realtime │   │Kullanıcı │        │
│  │ (00:00)│   │ Function │   │ Database │   │          │   │          │        │
│  └───┬────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘        │
│      │             │              │              │              │               │
│      │ 1. Trigger (Her gün 00:00)│              │              │               │
│      │────────────►│              │              │              │               │
│      │             │              │              │              │               │
│      │             │ 2. SELECT * FROM listings   │              │               │
│      │             │    WHERE status = 'active'  │              │               │
│      │             │    AND expires_at < NOW()   │              │               │
│      │             │─────────────►│              │              │               │
│      │             │              │              │              │               │
│      │             │ 3. Expired listings         │              │               │
│      │             │◄─────────────│              │              │               │
│      │             │              │              │              │               │
│      │             │ 4. FOR EACH expired listing:│              │               │
│      │             │    │         │              │              │               │
│      │             │    │ 4a. UPDATE status = 'expired'        │               │
│      │             │    │─────────►│              │              │               │
│      │             │    │         │              │              │               │
│      │             │    │ 4b. INSERT notification │              │               │
│      │             │    │─────────►│              │              │               │
│      │             │    │         │              │              │               │
│      │             │    │ 4c. Realtime broadcast  │              │               │
│      │             │    │─────────────────────────►              │               │
│      │             │    │         │              │              │               │
│      │             │    │         │              │ 4d. Push     │               │
│      │             │    │         │              │─────────────►│               │
│      │             │              │              │              │               │
│      │             │ 5. Email gönder (toplu)     │              │               │
│      │             │   (listing-expired template)│              │               │
│      │             │─────────────────────────────────────────────►               │
│      │             │              │              │              │               │
│      │             │ 6. Log: "X ilan expire edildi"             │               │
│      │             │─────────┐    │              │              │               │
│      │             │◄────────┘    │              │              │               │
│      │             │              │              │              │               │
│      │ 7. Complete │              │              │              │               │
│      │◄────────────│              │              │              │               │
│      │             │              │              │              │               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 7.6.2 Süre Dolum Uyarısı (3 Gün Kala)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      SÜRE DOLUM UYARISI SEQUENCE                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐                       │
│  │  Cron  │   │  Edge    │   │ Supabase │   │Kullanıcı │                       │
│  │ (09:00)│   │ Function │   │ Database │   │          │                       │
│  └───┬────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘                       │
│      │             │              │              │                              │
│      │ 1. Trigger (Her gün 09:00)│              │                              │
│      │────────────►│              │              │                              │
│      │             │              │              │                              │
│      │             │ 2. SELECT * FROM listings   │                              │
│      │             │    WHERE status = 'active'  │                              │
│      │             │    AND expires_at BETWEEN   │                              │
│      │             │    NOW() AND NOW() + 3 days │                              │
│      │             │─────────────►│              │                              │
│      │             │              │              │                              │
│      │             │ 3. Expiring soon listings   │                              │
│      │             │◄─────────────│              │                              │
│      │             │              │              │                              │
│      │             │ 4. FOR EACH listing:        │                              │
│      │             │    │         │              │                              │
│      │             │    │ 4a. INSERT notification │                              │
│      │             │    │    (type: 'listing_expiring_soon')                    │
│      │             │    │─────────►│              │                              │
│      │             │    │         │              │                              │
│      │             │    │ 4b. Email gönder       │                              │
│      │             │    │    (listing-expiring)  │                              │
│      │             │    │────────────────────────────────────►│                │
│      │             │              │              │                              │
│      │             │ 5. Log: "X kullanıcıya uyarı gönderildi" │                │
│      │             │─────────┐    │              │                              │
│      │             │◄────────┘    │              │                              │
│      │             │              │              │                              │
│      │ 6. Complete │              │              │                              │
│      │◄────────────│              │              │                              │
│      │             │              │              │                              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7.7 Favori ve Raporlama Senaryoları

### 7.7.1 Favorilere Ekleme
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       FAVORİLERE EKLEME SEQUENCE                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐     ┌────────────┐     ┌────────────┐                              │
│  │Öğrenci │     │  Next.js   │     │  Supabase  │                              │
│  │        │     │  Frontend  │     │  Database  │                              │
│  └───┬────┘     └─────┬──────┘     └─────┬──────┘                              │
│      │                │                  │                                      │
│      │ 1. Favori butonuna tıkla (♡)     │                                      │
│      │───────────────►│                  │                                      │
│      │                │                  │                                      │
│      │                │ 2. Optimistic update (♥)                               │
│      │◄───────────────│                  │                                      │
│      │                │                  │                                      │
│      │                │ 3. SELECT * FROM favorites                             │
│      │                │    WHERE user_id = X                                   │
│      │                │    AND listing_id = Y                                  │
│      │                │─────────────────►│                                      │
│      │                │                  │                                      │
│      │                │ 4. Kayıt yok     │                                      │
│      │                │◄─────────────────│                                      │
│      │                │                  │                                      │
│      │                │ 5. INSERT INTO favorites                               │
│      │                │─────────────────►│                                      │
│      │                │                  │                                      │
│      │                │ 6. Success       │                                      │
│      │                │◄─────────────────│                                      │
│      │                │                  │                                      │
│      │ 7. Konfirme (♥ kalır)            │                                      │
│      │◄───────────────│                  │                                      │
│      │                │                  │                                      │
│      │════════════════════════════════════════════════════════════════════════│
│      │                  FAVORİDEN ÇIKARMA (Toggle)                             │
│      │════════════════════════════════════════════════════════════════════════│
│      │                │                  │                                      │
│      │ 8. Favori butonuna tekrar tıkla (♥)                                     │
│      │───────────────►│                  │                                      │
│      │                │                  │                                      │
│      │                │ 9. Optimistic update (♡)                               │
│      │◄───────────────│                  │                                      │
│      │                │                  │                                      │
│      │                │ 10. DELETE FROM favorites                              │
│      │                │     WHERE user_id = X                                  │
│      │                │     AND listing_id = Y                                 │
│      │                │─────────────────►│                                      │
│      │                │                  │                                      │
│      │                │ 11. Success      │                                      │
│      │                │◄─────────────────│                                      │
│      │                │                  │                                      │
│      │ 12. Konfirme (♡ kalır)           │                                      │
│      │◄───────────────│                  │                                      │
│      │                │                  │                                      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 7.7.2 İlan Raporlama
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         İLAN RAPORLAMA SEQUENCE                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐                       │
│  │Öğrenci │   │ Next.js  │   │ Supabase │   │  Admin   │                       │
│  │        │   │ Frontend │   │ Database │   │          │                       │
│  └───┬────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘                       │
│      │             │              │              │                              │
│      │ 1. "Raporla" tıkla         │              │                              │
│      │────────────►│              │              │                              │
│      │             │              │              │                              │
│      │ 2. Rapor modalı göster     │              │                              │
│      │◄────────────│              │              │                              │
│      │             │              │              │                              │
│      │ 3. Sebep seç + Açıklama (opsiyonel)      │                              │
│      │   ┌─────────────────────────────────┐    │                              │
│      │   │ ○ Spam                          │    │                              │
│      │   │ ○ Uygunsuz içerik               │    │                              │
│      │   │ ○ Dolandırıcılık şüphesi        │    │                              │
│      │   │ ○ Yanlış kategori               │    │                              │
│      │   │ ○ Diğer                         │    │                              │
│      │   │                                 │    │                              │
│      │   │ Açıklama: [_______________]     │    │                              │
│      │   └─────────────────────────────────┘    │                              │
│      │────────────►│              │              │                              │
│      │             │              │              │                              │
│      │ 4. "Raporla" onayla        │              │                              │
│      │────────────►│              │              │                              │
│      │             │              │              │                              │
│      │             │ 5. Daha önce raporlamış mı?│                              │
│      │             │    SELECT * FROM reports   │                              │
│      │             │─────────────►│              │                              │
│      │             │              │              │                              │
│      │             │ 6. Kayıt yok │              │                              │
│      │             │◄─────────────│              │                              │
│      │             │              │              │                              │
│      │             │ 7. INSERT INTO reports      │                              │
│      │             │    (status: 'pending')      │                              │
│      │             │─────────────►│              │                              │
│      │             │              │              │                              │
│      │             │ 8. Success   │              │                              │
│      │             │◄─────────────│              │                              │
│      │             │              │              │                              │
│      │             │ 9. Admin bildirim           │                              │
│      │             │───────────────────────────────────────────►                │
│      │             │              │              │                              │
│      │ 10. "Raporunuz alındı, teşekkürler"      │                              │
│      │◄────────────│              │              │                              │
│      │             │              │              │                              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7.8 Özet Tablosu

| Senaryo | Aktörler | Kritik Adımlar | Hata Noktaları |
|:--------|:---------|:---------------|:---------------|
| Kayıt Olma | Misafir, Supabase, Email | Email doğrulama | Format, unique, token |
| Giriş Yapma | Misafir, Supabase | Credentials, ban kontrolü | Yanlış şifre, ban |
| Şifre Sıfırlama | Kullanıcı, Supabase, Email | Token doğrulama | Süresi dolmuş token |
| İlan Oluşturma | Öğrenci, Storage, DB | Fotoğraf yükleme, validasyon | Boyut, format |
| İlan Onaylama | Admin, DB, Realtime | Status güncelleme | - |
| İlan Reddetme | Admin, DB | Sebep yazma | - |
| Mesaj Gönderme | Öğrenci, DB, Realtime | Konuşma oluşturma | WebSocket bağlantısı |
| Satın Alma | Öğrenci, Iyzico, Banka | 3D Secure | Kart, bakiye, timeout |
| İlan Süresi Kontrolü | Sistem, DB | Batch update | - |
| Favorilere Ekleme | Öğrenci, DB | Toggle mantığı | - |
| İlan Raporlama | Öğrenci, DB, Admin | Unique constraint | Tekrar raporlama |

[[8. Veri Sözlüğü (Data Dictionary)]]