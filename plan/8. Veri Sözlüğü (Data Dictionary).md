[[7. Senaryo Detayları (Sequence Diagrams)]]
- - - - 

> Bu bölüm, sistemdeki tüm veri varlıklarını, özelliklerini, tiplerini ve kısıtlamalarını tanımlar.

---

## 8.1 Genel Bakış

Sistem veritabanı **PostgreSQL** (Supabase) üzerinde çalışmaktadır. Toplam **14 ana tablo** bulunmaktadır.
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            VERİTABANI ŞEMASI                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                       │
│  │universities │────►│  campuses   │     │ categories  │                       │
│  └─────────────┘     └─────────────┘     └─────────────┘                       │
│        │                   │                   │                                │
│        ▼                   ▼                   │                                │
│  ┌─────────────┐     ┌─────────────┐          │                                │
│  │cargo_       │     │   users     │          │                                │
│  │companies    │     │             │          │                                │
│  └─────────────┘     └──────┬──────┘          │                                │
│        │                    │                  │                                │
│        │                    ▼                  ▼                                │
│        │             ┌─────────────┐     ┌─────────────┐                       │
│        │             │  listings   │◄────│             │                       │
│        │             └──────┬──────┘     └─────────────┘                       │
│        │                    │                                                   │
│        │     ┌──────────────┼──────────────┬───────────────┐                   │
│        │     │              │              │               │                   │
│        │     ▼              ▼              ▼               ▼                   │
│        │ ┌─────────┐  ┌─────────┐   ┌──────────┐    ┌──────────┐              │
│        │ │favorites│  │ reports │   │conversa- │    │transac-  │              │
│        │ └─────────┘  └─────────┘   │  tions   │    │  tions   │              │
│        │                            └────┬─────┘    └────┬─────┘              │
│        │                                 │               │                     │
│        │                                 ▼               ▼                     │
│        │                           ┌─────────┐    ┌──────────┐                │
│        │                           │messages │    │shipments │                │
│        │                           └─────────┘    └────┬─────┘                │
│        │                                               │                       │
│        └───────────────────────────────────────────────┤                       │
│                                                        ▼                       │
│                                                 ┌─────────────┐                │
│                                                 │  delivery   │                │
│                                                 │confirmations│                │
│                                                 └─────────────┘                │
│                                                                                 │
│  ┌─────────────┐                                                               │
│  │notifications│                                                               │
│  └─────────────┘                                                               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8.2 Tablo Detayları

### 8.2.1 users (Kullanıcılar)

> Sistemdeki tüm kullanıcı bilgilerini saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `email` | VARCHAR(255) | NO | - | Kullanıcı email (.edu.tr) |
| `full_name` | VARCHAR(100) | NO | - | Ad soyad |
| `avatar_url` | TEXT | YES | NULL | Profil fotoğrafı URL |
| `university_id` | UUID | YES | NULL | Üniversite referansı |
| `campus_id` | UUID | YES | NULL | Kampüs referansı |
| `phone` | VARCHAR(20) | YES | NULL | Telefon numarası |
| `bio` | VARCHAR(500) | YES | NULL | Hakkında metni |
| `is_verified` | BOOLEAN | NO | FALSE | Email doğrulandı mı |
| `is_admin` | BOOLEAN | NO | FALSE | Admin yetkisi |
| `is_banned` | BOOLEAN | NO | FALSE | Yasaklı mı |
| `ban_reason` | TEXT | YES | NULL | Yasaklama sebebi |
| `ban_until` | TIMESTAMP | YES | NULL | Yasaklama bitiş tarihi |
| `created_at` | TIMESTAMP | NO | `NOW()` | Kayıt tarihi |
| `updated_at` | TIMESTAMP | NO | `NOW()` | Son güncelleme |

#### Kısıtlamalar (Constraints)

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `users_pkey` | PRIMARY KEY | `id` |
| `users_email_key` | UNIQUE | `email` |
| `users_university_fkey` | FOREIGN KEY | `university_id` → `universities(id)` |
| `users_campus_fkey` | FOREIGN KEY | `campus_id` → `campuses(id)` |
| `chk_edu_email` | CHECK | `email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.edu\.tr$'` |

#### İndeksler

| İndeks | Kolonlar | Tip |
|:-------|:---------|:----|
| `idx_users_email` | `email` | BTREE |
| `idx_users_is_admin` | `is_admin` | BTREE |
| `idx_users_university` | `university_id` | BTREE |
| `idx_users_campus` | `campus_id` | BTREE |

---

### 8.2.2 universities (Üniversiteler)

> Türkiye'deki üniversiteleri ve kargo anlaşmalarını saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `name` | VARCHAR(150) | NO | - | Üniversite adı |
| `short_name` | VARCHAR(20) | YES | NULL | Kısa ad (ör: İTÜ, ODTÜ) |
| `city` | VARCHAR(50) | NO | - | Şehir |
| `email_domain` | VARCHAR(100) | NO | - | Email domain (ör: itu.edu.tr) |
| `has_cargo_partnership` | BOOLEAN | NO | FALSE | Anlaşmalı kargo var mı |
| `partner_cargo_id` | UUID | YES | NULL | Anlaşmalı kargo şirketi |
| `is_active` | BOOLEAN | NO | TRUE | Aktif mi |
| `created_at` | TIMESTAMP | NO | `NOW()` | Oluşturma tarihi |

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `universities_pkey` | PRIMARY KEY | `id` |
| `universities_name_key` | UNIQUE | `name` |
| `universities_domain_key` | UNIQUE | `email_domain` |
| `universities_cargo_fkey` | FOREIGN KEY | `partner_cargo_id` → `cargo_companies(id)` |

---

### 8.2.3 campuses (Kampüsler)

> Üniversitelerin kampüslerini saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `university_id` | UUID | NO | - | Üniversite referansı |
| `name` | VARCHAR(100) | NO | - | Kampüs adı |
| `city` | VARCHAR(50) | NO | - | Şehir |
| `district` | VARCHAR(50) | YES | NULL | İlçe |
| `address` | TEXT | YES | NULL | Tam adres |
| `is_main_campus` | BOOLEAN | NO | FALSE | Ana kampüs mü |
| `is_active` | BOOLEAN | NO | TRUE | Aktif mi |
| `created_at` | TIMESTAMP | NO | `NOW()` | Oluşturma tarihi |

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `campuses_pkey` | PRIMARY KEY | `id` |
| `campuses_university_fkey` | FOREIGN KEY | `university_id` → `universities(id)` |
| `campuses_unique` | UNIQUE | `university_id, name` |

---

### 8.2.4 cargo_companies (Kargo Şirketleri)

> Platform ve üniversite anlaşmalı kargo şirketlerini saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `name` | VARCHAR(50) | NO | - | Kargo şirketi adı |
| `code` | VARCHAR(10) | NO | - | Kısa kod (ör: YK, ARAS) |
| `logo_url` | TEXT | YES | NULL | Logo URL |
| `tracking_url_template` | TEXT | YES | NULL | Takip linki şablonu |
| `is_platform_partner` | BOOLEAN | NO | FALSE | Platform anlaşmalı mı |
| `is_active` | BOOLEAN | NO | TRUE | Aktif mi |
| `created_at` | TIMESTAMP | NO | `NOW()` | Oluşturma tarihi |

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `cargo_companies_pkey` | PRIMARY KEY | `id` |
| `cargo_companies_name_key` | UNIQUE | `name` |
| `cargo_companies_code_key` | UNIQUE | `code` |

---

### 8.2.5 categories (Kategoriler)

> İlan kategorilerini hiyerarşik yapıda saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `name` | VARCHAR(50) | NO | - | Kategori adı |
| `slug` | VARCHAR(50) | NO | - | URL-friendly isim |
| `icon` | VARCHAR(50) | YES | NULL | Lucide icon adı |
| `parent_id` | UUID | YES | NULL | Üst kategori ID (self-ref) |
| `order` | INTEGER | NO | 0 | Sıralama |
| `is_active` | BOOLEAN | NO | TRUE | Aktif mi |
| `created_at` | TIMESTAMP | NO | `NOW()` | Oluşturma tarihi |

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `categories_pkey` | PRIMARY KEY | `id` |
| `categories_name_key` | UNIQUE | `name` |
| `categories_slug_key` | UNIQUE | `slug` |
| `categories_parent_fkey` | FOREIGN KEY | `parent_id` → `categories(id)` |

#### Örnek Veriler
```sql
INSERT INTO categories (name, slug, icon, parent_id, "order") VALUES
('Elektronik', 'elektronik', 'Smartphone', NULL, 1),
('Telefon & Aksesuar', 'telefon-aksesuar', 'Phone', '<elektronik_id>', 1),
('Bilgisayar & Tablet', 'bilgisayar-tablet', 'Laptop', '<elektronik_id>', 2),
('Kitap & Kırtasiye', 'kitap-kirtasiye', 'BookOpen', NULL, 2),
('Ders Kitabı', 'ders-kitabi', 'GraduationCap', '<kitap_id>', 1),
('Ev & Yaşam', 'ev-yasam', 'Home', NULL, 3),
('Giyim & Aksesuar', 'giyim-aksesuar', 'Shirt', NULL, 4),
('Spor & Hobi', 'spor-hobi', 'Dumbbell', NULL, 5),
('Diğer', 'diger', 'Package', NULL, 99);
```

---

### 8.2.3 listings (İlanlar)

> Tüm ürün ilanlarını saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `user_id` | UUID | NO | - | İlan sahibi |
| `category_id` | UUID | NO | - | Kategori |
| `title` | VARCHAR(100) | NO | - | İlan başlığı |
| `description` | TEXT | NO | - | Açıklama |
| `price` | DECIMAL(10,2) | NO | - | Fiyat (TL) |
| `images` | TEXT[] | NO | - | Fotoğraf URL dizisi |
| `status` | listing_status | NO | 'draft' | İlan durumu |
| `condition` | listing_condition | NO | - | Ürün durumu |
| `view_count` | INTEGER | NO | 0 | Görüntülenme sayısı |
| `expires_at` | TIMESTAMP | YES | NULL | Son geçerlilik |
| `rejection_reason` | TEXT | YES | NULL | Ret sebebi |
| `created_at` | TIMESTAMP | NO | `NOW()` | Oluşturma tarihi |
| `updated_at` | TIMESTAMP | NO | `NOW()` | Son güncelleme |

#### Enum Tipleri
```sql
-- İlan durumu
CREATE TYPE listing_status AS ENUM (
    'draft',      -- Taslak
    'pending',    -- Onay bekliyor
    'active',     -- Yayında
    'sold',       -- Satıldı
    'expired',    -- Süresi doldu
    'rejected',   -- Reddedildi
    'removed'     -- Admin tarafından kaldırıldı
);

-- Ürün durumu
CREATE TYPE listing_condition AS ENUM (
    'new',        -- Sıfır/Kutusunda
    'like_new',   -- Sıfır Gibi
    'good',       -- İyi
    'fair',       -- Orta
    'poor'        -- Kötü
);
```

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `listings_pkey` | PRIMARY KEY | `id` |
| `listings_user_fkey` | FOREIGN KEY | `user_id` → `users(id)` |
| `listings_category_fkey` | FOREIGN KEY | `category_id` → `categories(id)` |
| `chk_title_length` | CHECK | `length(title) >= 5 AND length(title) <= 100` |
| `chk_description_length` | CHECK | `length(description) >= 20` |
| `chk_price_range` | CHECK | `price > 0 AND price <= 100000` |
| `chk_images_count` | CHECK | `array_length(images, 1) >= 1 AND array_length(images, 1) <= 5` |

#### İndeksler

| İndeks | Kolonlar | Tip |
|:-------|:---------|:----|
| `idx_listings_user_id` | `user_id` | BTREE |
| `idx_listings_category_id` | `category_id` | BTREE |
| `idx_listings_status` | `status` | BTREE |
| `idx_listings_created_at` | `created_at DESC` | BTREE |
| `idx_listings_price` | `price` | BTREE |
| `idx_listings_search` | `title, description` | GIN (Full-text) |

---

### 8.2.4 conversations (Konuşmalar)

> İlan bazlı mesajlaşma konuşmalarını saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `listing_id` | UUID | NO | - | İlgili ilan |
| `buyer_id` | UUID | NO | - | Alıcı (mesajı başlatan) |
| `seller_id` | UUID | NO | - | Satıcı (ilan sahibi) |
| `last_message_at` | TIMESTAMP | YES | NULL | Son mesaj zamanı |
| `created_at` | TIMESTAMP | NO | `NOW()` | Oluşturma tarihi |
| `updated_at` | TIMESTAMP | NO | `NOW()` | Son güncelleme |

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `conversations_pkey` | PRIMARY KEY | `id` |
| `conversations_listing_fkey` | FOREIGN KEY | `listing_id` → `listings(id)` |
| `conversations_buyer_fkey` | FOREIGN KEY | `buyer_id` → `users(id)` |
| `conversations_seller_fkey` | FOREIGN KEY | `seller_id` → `users(id)` |
| `conversations_unique` | UNIQUE | `(listing_id, buyer_id)` |
| `chk_different_users` | CHECK | `buyer_id != seller_id` |

---

### 8.2.5 messages (Mesajlar)

> Konuşmalardaki mesajları saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `conversation_id` | UUID | NO | - | İlgili konuşma |
| `sender_id` | UUID | NO | - | Gönderen kullanıcı |
| `content` | TEXT | NO | - | Mesaj içeriği |
| `is_read` | BOOLEAN | NO | FALSE | Okundu mu |
| `read_at` | TIMESTAMP | YES | NULL | Okunma zamanı |
| `created_at` | TIMESTAMP | NO | `NOW()` | Gönderim zamanı |

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `messages_pkey` | PRIMARY KEY | `id` |
| `messages_conversation_fkey` | FOREIGN KEY | `conversation_id` → `conversations(id)` |
| `messages_sender_fkey` | FOREIGN KEY | `sender_id` → `users(id)` |
| `chk_content_not_empty` | CHECK | `length(trim(content)) > 0` |

#### İndeksler

| İndeks | Kolonlar | Tip |
|:-------|:---------|:----|
| `idx_messages_conversation` | `conversation_id` | BTREE |
| `idx_messages_created_at` | `created_at DESC` | BTREE |

---

### 8.2.6 favorites (Favoriler)

> Kullanıcıların favori ilanlarını saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `user_id` | UUID | NO | - | Kullanıcı |
| `listing_id` | UUID | NO | - | Favori ilan |
| `created_at` | TIMESTAMP | NO | `NOW()` | Eklenme tarihi |

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `favorites_pkey` | PRIMARY KEY | `id` |
| `favorites_user_fkey` | FOREIGN KEY | `user_id` → `users(id)` |
| `favorites_listing_fkey` | FOREIGN KEY | `listing_id` → `listings(id)` |
| `favorites_unique` | UNIQUE | `(user_id, listing_id)` |

---

### 8.2.7 reports (Raporlar)

> Kullanıcıların ilan raporlarını saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `reporter_id` | UUID | NO | - | Raporlayan kullanıcı |
| `listing_id` | UUID | NO | - | Raporlanan ilan |
| `reason` | report_reason | NO | - | Rapor sebebi |
| `description` | TEXT | YES | NULL | Ek açıklama |
| `status` | report_status | NO | 'pending' | Rapor durumu |
| `admin_id` | UUID | YES | NULL | İşlem yapan admin |
| `admin_note` | TEXT | YES | NULL | Admin notu |
| `created_at` | TIMESTAMP | NO | `NOW()` | Rapor tarihi |
| `resolved_at` | TIMESTAMP | YES | NULL | Çözüm tarihi |

#### Enum Tipleri
```sql
-- Rapor sebebi
CREATE TYPE report_reason AS ENUM (
    'spam',           -- Spam
    'inappropriate',  -- Uygunsuz içerik
    'fraud',          -- Dolandırıcılık
    'wrong_category', -- Yanlış kategori
    'duplicate',      -- Tekrar ilan
    'other'           -- Diğer
);

-- Rapor durumu
CREATE TYPE report_status AS ENUM (
    'pending',   -- Bekliyor
    'reviewed',  -- İncelendi
    'resolved',  -- Çözüldü
    'dismissed'  -- Reddedildi
);
```

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `reports_pkey` | PRIMARY KEY | `id` |
| `reports_reporter_fkey` | FOREIGN KEY | `reporter_id` → `users(id)` |
| `reports_listing_fkey` | FOREIGN KEY | `listing_id` → `listings(id)` |
| `reports_admin_fkey` | FOREIGN KEY | `admin_id` → `users(id)` |
| `reports_unique` | UNIQUE | `(reporter_id, listing_id)` |

---

### 8.2.8 transactions (İşlemler)

> Ödeme işlemlerini saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `listing_id` | UUID | NO | - | Satılan ilan |
| `buyer_id` | UUID | NO | - | Alıcı |
| `seller_id` | UUID | NO | - | Satıcı |
| `amount` | DECIMAL(10,2) | NO | - | Tutar (TL) |
| `status` | transaction_status | NO | 'pending' | İşlem durumu |
| `iyzico_payment_id` | VARCHAR(100) | YES | NULL | Iyzico payment ID |
| `iyzico_conversation_id` | VARCHAR(100) | YES | NULL | Iyzico conversation ID |
| `error_message` | TEXT | YES | NULL | Hata mesajı |
| `created_at` | TIMESTAMP | NO | `NOW()` | İşlem başlangıcı |
| `completed_at` | TIMESTAMP | YES | NULL | Tamamlanma zamanı |

#### Enum Tipi
```sql
CREATE TYPE transaction_status AS ENUM (
    'pending',     -- Bekliyor
    'processing',  -- İşleniyor
    'completed',   -- Tamamlandı
    'failed',      -- Başarısız
    'refunded',    -- İade edildi
    'cancelled'    -- İptal edildi
);
```

---

### 8.2.10 shipments (Gönderiler)

> Teslimat/kargo bilgilerini saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `transaction_id` | UUID | NO | - | İlgili işlem |
| `delivery_type` | delivery_type | NO | - | Teslimat tipi |
| `cargo_company_id` | UUID | YES | NULL | Kargo şirketi (kargo ise) |
| `tracking_code` | VARCHAR(50) | YES | NULL | Kargo takip numarası |
| `delivery_code` | VARCHAR(8) | NO | - | Platform teslimat kodu |
| `status` | shipment_status | NO | 'pending_shipment' | Gönderi durumu |
| `seller_shipped_at` | TIMESTAMP | YES | NULL | Kargoya verilme zamanı |
| `delivered_at` | TIMESTAMP | YES | NULL | Teslim edilme zamanı |
| `confirmed_at` | TIMESTAMP | YES | NULL | Onaylanma zamanı |
| `auto_confirmed` | BOOLEAN | NO | FALSE | Otomatik onay mı |
| `created_at` | TIMESTAMP | NO | `NOW()` | Oluşturma tarihi |
| `updated_at` | TIMESTAMP | NO | `NOW()` | Son güncelleme |

#### Enum Tipleri
```sql
-- Teslimat tipi
CREATE TYPE delivery_type AS ENUM (
    'hand_to_hand',  -- Elden teslim
    'cargo'          -- Kargo ile
);

-- Gönderi durumu
CREATE TYPE shipment_status AS ENUM (
    'pending_shipment',  -- Gönderim bekleniyor (satıcı henüz göndermedi)
    'shipped',           -- Gönderildi (kargoya verildi)
    'in_transit',        -- Yolda
    'delivered',         -- Teslim edildi (kargo teslim etti, onay bekleniyor)
    'confirmed',         -- Onaylandı (alıcı onayladı veya 72 saat geçti)
    'disputed'           -- İtiraz edildi
);
```

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `shipments_pkey` | PRIMARY KEY | `id` |
| `shipments_transaction_fkey` | FOREIGN KEY | `transaction_id` → `transactions(id)` |
| `shipments_cargo_fkey` | FOREIGN KEY | `cargo_company_id` → `cargo_companies(id)` |
| `shipments_transaction_unique` | UNIQUE | `transaction_id` |
| `shipments_delivery_code_key` | UNIQUE | `delivery_code` |
| `chk_cargo_requires_company` | CHECK | `delivery_type = 'hand_to_hand' OR cargo_company_id IS NOT NULL` |

#### İndeksler

| İndeks | Kolonlar | Tip |
|:-------|:---------|:----|
| `idx_shipments_transaction` | `transaction_id` | BTREE |
| `idx_shipments_status` | `status` | BTREE |
| `idx_shipments_delivery_code` | `delivery_code` | BTREE |

---

### 8.2.11 delivery_confirmations (Teslimat Onayları)

> Teslimat doğrulama bilgilerini saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `shipment_id` | UUID | NO | - | İlgili gönderi |
| `seller_photo_url` | TEXT | YES | NULL | Satıcı ürün fotoğrafı |
| `seller_package_photo_url` | TEXT | YES | NULL | Paketleme fotoğrafı |
| `seller_confirmed_at` | TIMESTAMP | YES | NULL | Satıcı onay zamanı |
| `buyer_confirmed_at` | TIMESTAMP | YES | NULL | Alıcı onay zamanı |
| `dispute_reason` | TEXT | YES | NULL | İtiraz sebebi |
| `dispute_photos` | TEXT[] | YES | NULL | İtiraz fotoğrafları |
| `dispute_opened_at` | TIMESTAMP | YES | NULL | İtiraz açılma zamanı |
| `dispute_resolved_at` | TIMESTAMP | YES | NULL | İtiraz çözülme zamanı |
| `dispute_resolution` | dispute_resolution | YES | NULL | İtiraz kararı |
| `admin_id` | UUID | YES | NULL | İtirazı çözen admin |
| `admin_note` | TEXT | YES | NULL | Admin notu |
| `created_at` | TIMESTAMP | NO | `NOW()` | Oluşturma tarihi |
| `updated_at` | TIMESTAMP | NO | `NOW()` | Son güncelleme |

#### Enum Tipi
```sql
-- İtiraz çözüm kararı
CREATE TYPE dispute_resolution AS ENUM (
    'refund_buyer',      -- Alıcıya iade
    'release_seller',    -- Satıcıya ödeme
    'partial_refund'     -- Kısmi iade
);
```

#### Kısıtlamalar

| Kısıtlama | Tip | Tanım |
|:----------|:----|:------|
| `delivery_confirmations_pkey` | PRIMARY KEY | `id` |
| `delivery_confirmations_shipment_fkey` | FOREIGN KEY | `shipment_id` → `shipments(id)` |
| `delivery_confirmations_admin_fkey` | FOREIGN KEY | `admin_id` → `users(id)` |
| `delivery_confirmations_shipment_unique` | UNIQUE | `shipment_id` |

---

### 8.2.12 notifications (Bildirimler)

> Kullanıcı bildirimlerini saklar.

| Kolon | Veri Tipi | Null | Default | Açıklama |
|:------|:----------|:----:|:--------|:---------|
| `id` | UUID | NO | `gen_random_uuid()` | Birincil anahtar |
| `user_id` | UUID | NO | - | Alıcı kullanıcı |
| `type` | notification_type | NO | - | Bildirim tipi |
| `title` | VARCHAR(100) | NO | - | Başlık |
| `message` | TEXT | NO | - | İçerik |
| `data` | JSONB | YES | NULL | Ek veri (link, ID'ler) |
| `is_read` | BOOLEAN | NO | FALSE | Okundu mu |
| `created_at` | TIMESTAMP | NO | `NOW()` | Oluşturma tarihi |

#### Enum Tipi
```sql
CREATE TYPE notification_type AS ENUM (
    'new_message',           -- Yeni mesaj
    'listing_approved',      -- İlan onaylandı
    'listing_rejected',      -- İlan reddedildi
    'listing_sold',          -- İlan satıldı
    'listing_expired',       -- İlan süresi doldu
    'listing_expiring_soon', -- İlan süresi dolmak üzere
    'favorite_sold',         -- Favori ilan satıldı
    'payment_received',      -- Ödeme alındı
    'payment_failed',        -- Ödeme başarısız
    'report_resolved',       -- Rapor çözüldü
    'shipment_created',      -- Gönderi oluşturuldu
    'shipment_shipped',      -- Kargoya verildi
    'shipment_delivered',    -- Teslim edildi
    'delivery_confirmed',    -- Teslimat onaylandı
    'delivery_reminder',     -- Teslim onayı hatırlatması
    'dispute_opened',        -- İtiraz açıldı
    'dispute_resolved',      -- İtiraz çözüldü
    'system'                 -- Sistem bildirimi
);
```

---

## 8.3 İlişki Diyagramı (ER Diagram)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          ENTITY RELATIONSHIP DIAGRAM                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                              ┌─────────────┐                                    │
│                              │ categories  │                                    │
│                              ├─────────────┤                                    │
│                              │ PK: id      │◄──┐                                │
│                              │ name        │   │ (self-ref)                     │
│                              │ slug        │   │                                │
│                              │ parent_id   │───┘                                │
│                              └──────┬──────┘                                    │
│                                     │ 1                                         │
│                                     │                                           │
│  ┌─────────────┐                    │ *                                         │
│  │   users     │              ┌─────▼─────┐                                     │
│  ├─────────────┤              │ listings  │                                     │
│  │ PK: id      │◄────────────┤├───────────┤                                     │
│  │ email       │    1      * │ PK: id     │                                     │
│  │ full_name   │              │ FK: user_id│                                    │
│  │ is_verified │              │ FK: category_id                                 │
│  │ is_admin    │              │ title      │                                    │
│  │ is_banned   │              │ price      │                                    │
│  └──────┬──────┘              │ status     │                                    │
│         │                     └─────┬──────┘                                    │
│         │                           │                                           │
│         │ 1                         │ 1                                         │
│         │                           │                                           │
│    ┌────┴─────┬─────────┬───────────┼─────────┬─────────┐                      │
│    │          │         │           │         │         │                      │
│    │ *        │ *       │ *         │ *       │ *       │ *                    │
│    ▼          ▼         ▼           ▼         ▼         ▼                      │
│ ┌──────┐  ┌──────┐  ┌────────┐  ┌───────┐  ┌───────┐  ┌─────────┐            │
│ │favor-│  │notif-│  │conver- │  │reports│  │trans- │  │messages │            │
│ │ites  │  │icat- │  │sations │  │       │  │actions│  │         │            │
│ ├──────┤  │ions  │  ├────────┤  ├───────┤  ├───────┤  ├─────────┤            │
│ │PK:id │  ├──────┤  │PK: id  │  │PK: id │  │PK: id │  │PK: id   │            │
│ │FK:   │  │PK:id │  │FK:list-│  │FK:rep-│  │FK:list│  │FK:conv- │            │
│ │user  │  │FK:   │  │  ing   │  │  orter│  │  ing  │  │  ersation│           │
│ │FK:   │  │user  │  │FK:buyer│  │FK:list│  │FK:buyer  │FK:sender│            │
│ │list- │  │type  │  │FK:sell-│  │  ing  │  │FK:sell│  │content  │            │
│ │ing   │  │title │  │  er    │  │reason │  │  er   │  │is_read  │            │
│ └──────┘  │is_read  └───┬────┘  │status │  │amount │  └─────────┘            │
│           └──────┘      │       └───────┘  │status │                          │
│                         │ 1                └───────┘                          │
│                         │                                                      │
│                         │ *                                                    │
│                    ┌────▼────┐                                                 │
│                    │messages │                                                 │
│                    └─────────┘                                                 │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8.4 Özet

| Tablo | Kayıt Tipi | Tahmini Boyut | İlişkiler |
|:------|:-----------|:--------------|:----------|
| `users` | Kullanıcı | 50.000+ | universities, campuses, 7 FK referansı |
| `universities` | Üniversite | ~200 | campuses, cargo_companies |
| `campuses` | Kampüs | ~500 | universities, users |
| `cargo_companies` | Kargo | ~10 | universities, shipments |
| `categories` | Kategori | ~50 | Self-ref, listings |
| `listings` | İlan | 100.000+ | users, categories |
| `conversations` | Konuşma | 200.000+ | listings, users |
| `messages` | Mesaj | 1.000.000+ | conversations, users |
| `favorites` | Favori | 500.000+ | users, listings |
| `reports` | Rapor | 10.000+ | users, listings |
| `transactions` | İşlem | 50.000+ | listings, users |
| `shipments` | Gönderi | 50.000+ | transactions, cargo_companies |
| `delivery_confirmations` | Teslimat Onay | 50.000+ | shipments, users |
| `notifications` | Bildirim | 500.000+ | users |


[[9. İş Kuralları (Business Rules)]]